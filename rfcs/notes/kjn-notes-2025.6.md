# 6月工作记录

6月的工作主要是完善Agent系统的功能流程，实现Rust功能领域下的RAG Agent。

## cmd命令行交互程序实现

原有的api_client.py严格来讲只是一个测试程序，并没有实现完整的cmd命令行交互功能。因此，我编写了cmd_client.py，实现了完整的cmd命令行交互功能。

交互行主体如下：

```bash
请输入您的选择 (1-8): 无效的选择。请输入 1 到 7 之间的数字。

--- RAG 系统客户端菜单 ---
1. 获取 API 文档
2. 执行健康检查
3. 创建新知识库
4. 上传文件到知识库
5. 开始文档聊天
6. 列出知识库
7. 退出
--------------------------
```

目前实现有6个主体功能，还是比较简陋。

具体代码详见cmd_client.py文件。

## pdf上传bug修复

在Agent进行上传pdf文件时，输入过程和报错如下：

```bash
请输入您的选择 (1-8): 4
[2025-06-29 21:33:05] INFO: 正在启动文件上传到知识库流程...
请输入要上传文件的绝对路径 (例如: /path/to/my_document.pdf): /home/kjn/docs/Rust/test-Rust.pdf
请输入用户ID (例如: user_001, 默认: abc1234): 
请输入用户信息 (可选, 默认: 5678): 
请输入目标知识库ID (必填, 例如: KBxxxxxxxxxxxxxxxxxxxxxxxxxxxxx): KB0790b3f33b704629871dc39868f0ae30
请输入处理模式 (soft/strict, 默认: soft): 
[2025-06-29 21:33:13] INFO: 正在上传文件 'test-Rust.pdf' 到知识库 'KB0790b3f33b704629871dc39868f0ae30'...
[2025-06-29 21:33:13] ERROR: 1 次尝试全部失败 (http://127.0.0.1:8777/api/qa_handler/upload_files): 500, message='Internal Server Error', url='http://127.0.0.1:8777/api/qa_handler/upload_files'
[2025-06-29 21:33:13] ERROR: 文件上传失败: 500, message='Internal Server Error', url='http://127.0.0.1:8777/api/qa_handler/upload_files'
```

sanic服务器报错信息如下：

```bash
TypeError: FileHandler.load_pdf() takes 1 positional argument but 2 were given
```

经过反复排查和调试，发现是`FileHandler.load_pdf()`函数的参数不匹配导致的。在`FileHandler.load_pdf()`函数中，我们期望接收一个参数，但在调用时却传入了两个参数。

原来在 Python 中，当您在一个类内部定义一个方法时（例如 FileHandler 类中的 load_pdf 方法），该方法的第一个参数约定俗成地命名为 self。这个 self 参数会自动指向调用该方法的类实例。Python 会隐式地将 self 作为第一个位置参数传递给方法。

因此修改file_handler.py文件中的此类错误，即可解决bug。

## llm报错bug

在使用Agent的过程中，发生了长时间无法生成回答的情况。经过排查，发现是llm的问题，重启llm后问题解决。

## Rust Agent实现效果

命令行的使用效果如下，交互过程中，可以自主输入用户信息，选择目标知识库，输入问题，以及流式响应，温度等超参数。当前功能较为繁琐，后续可以进行简化。

```bash
--- RAG 系统客户端菜单 ---
1. 获取 API 文档
2. 执行健康检查
3. 创建新知识库
4. 上传文件到知识库
5. 开始文档聊天
6. 列出知识库
7. 退出
--------------------------

请输入您的选择 (1-7): 5
[2025-06-29 23:34:03] INFO: 正在启动本地文档聊天会话...
请输入用户ID (例如: user_001, 默认: abc1234): 
请输入用户信息 (可选, 默认: 5678): 
请输入用逗号分隔的知识库ID (必填, 例如: KB1,KB2): KB02b6b16ef5f64432876601b99831ab68
请输入您的问题 (必填): 介绍一下The Rust core allocation and collections library
是否启用流式响应? (yes/no, 默认: no): 
请输入聊天历史记录，格式为 JSON 数组 (例如: [["你好", "您好"]], 留空表示无): 
响应最大 Token 数 (默认: 3000): 
温度 (0.0-1.0, 默认: 0.7): 
Top-p (0.0-1.0, 默认: 0.99): 
检索 Top-k (默认: 5): 
是否启用重排 (rerank)? (yes/no, 默认: yes): 
[2025-06-29 23:34:23] INFO: 正在发送聊天请求到 http://127.0.0.1:8777/api/local_doc_qa/local_doc_chat...

--- 聊天响应 ---
根据参考信息，Rust 核心分配和集合库提供了智能指针和集合，用于管理堆分配的值。该库自 1.36.0 版本以来一直存在，通常不需要直接使用，因为其内容会在 std 库中重新导出。对于使用 \#![no_std] 属性的库来说，它们通常不会依赖 std，因此会使用这个库。

该库包括以下内容：
- **Boxed 值**：`Box` 类型是一种智能指针类型，只有一个所有者，并且所有者可以决定是否修改存储在堆上的内容。
- **引用计数指针**：
  - `Rc` 类型是非线程安全的引用计数指针类型，用于在单线程环境中共享内存。`Rc` 指针包装一个类型 T，并且仅允许访问 &T，一个共享引用。
  - `Arc` 类型是 `Rc` 类型的线程安全等价物，提供了与 `Rc` 相同的功能，但是包含的类型 T 必须是可共享的，同时 `Arc<T>` 本身是可发送的。
- **集合**：实现了一些最常见的通用数据结构，如 `Vec<T>` 和 `String`。
- **其他模块**：提供了与其他线程安全操作相关的模块，如 `borrow`、`sync` 等。

这些组件共同构成了 Rust 程序中管理和操作堆分配数据的基础。
----------------
```

## 未来工作完善

1. 借鉴qanything，实现完整美观的UI界面。
2. 完善Rust Agent功能，实现更简洁的交互流程。
3. 流式响应有一点bug，后续需要修复。

