# 20250428 RAG流程测试报告

## 测试目标
重测试整体 RAG 流程，比较优化后与优化前 RAG 系统输出

## 测试记录

基座模型：Qwen2.5-32B-Instruct-AWQ

### PDF 输入测试记录

采用 RISC-V 官方文档 riscv-privileged.pdf 作为测试文档进行测试，仍产生 list index out of range 问题。下一步工作应当着重解决 txt 以外格式文档上传问题。

### TXT 输入测试记录

短 txt 文档测试：

采用朱自清《荷塘月色》作为测试文档。知识库建立、文档上传，RAG问答流程正常。

| 输入Query |   输出 Response（旧） |  存在的问题 |  输出 Response（新）  |  问题是否解决  |
|-----------| ---------------| ---------- | ---------- | ---------- |
|“荡舟心许”出自谁的诗？|"根据参考信息，“荡舟心许”出自《西洲曲》中的句子。|误将后文提到另一首诗标题作为当前诗标题，疑似因分块位置及重排序顺序所致。 | 根据参考信息，“荡舟心许”出自梁元帝的《采莲赋》。 | 问题已解决。 |
|作者是什么时候去散步的？|根据参考信息，作者是晚上在院子里散步的。具体时间描述为“这几天心里颇不宁静。今晚在院子里坐着乘凉，忽然想起日日走过的荷塘，在这满月的光里，总该另有一番样子吧。”从中可以推断，作者是在一个满月的晚上散步的。|部分正确，没有答到一九二七年这个大时间点。查看检索得到的块，“一九二七年”所在块排相关度第三位，可能为模型能力限制所致。| 根据参考信息，作者是在晚上散步的。文中提到“今晚在院子里坐着乘凉，忽然想起日日走过的荷塘”，表明作者是在晚上出门散步。 | 问题基本解决，“时间”这一描述与“晚上”对应。|
|作者将荷花比作什么？|According to the reference information,作者将荷花比作亭亭的舞女的裙、一粒粒的明珠、碧天里的星星、刚出浴的美人。\\n\\n具体来说，原文中有以下描述：\\n- “叶子出水很高，像亭亭的舞女的裙。”\\n- “正如一粒粒的明珠，又如碧天里的星星，又如刚出浴的美人。”\\n这些比喻形象地描绘了荷花的美丽姿态和光彩。|存在中英文混杂和查询理解错误的问题。误将对叶子的描述理解为对荷花的描述。| 根据参考信息，作者将荷花比作了明珠、星星和刚出浴的美人。\n\n- 明珠：荷花像一粒粒的明珠。\n- 星星：荷花又如碧天里的星星。\n- 刚出浴的美人：荷花又如刚出浴的美人。 | 问题已解决，不再使用英文回答问题。 |

长 txt 文档测试：

采用 RISC-V 官方文档 riscv-privileged.pdf 简单转换得到的 riscv-privileged.txt 作为测试文档。共10867行。知识库建立正常。调用接口进行文档上传及解析时出现 Failed to upload file (HTTP 503): 503 — Service Unavailable 问题，为 Response Timeout 所致，但文档成功上传并分片，未影响后续测试流程。RAG问答流程正常。

本月更新后，系统仍存在超时问题。

| 输入Query |   输出 Response（旧） |  存在的问题 |  输出 Response（新）  |  问题是否解决  |
|-----------| ---------------| ---------- | ---------- | ---------- |
|RISC-V架构中定义了哪几种特权级别？|According to the reference information, RISC-V架构中定义了三种特权级别，分别是：\n\n- **User/Application (U)**：用户或应用级别。\n- **Supervisor (S)**：监督器级别。\n- **Machine (M)**：机器级别。\n\n这些特权级别用于在软件堆栈的不同组件之间提供保护，并且尝试执行当前特权模式不允许的操作将引发异常，这些异常通常会导致进入较低的特权执行环境。|存在中英文混杂问题。| 根据参考信息，RISC-V架构中定义了以下几种特权级别：\n\n- **用户/应用级别（U-mode）**\n- **监督级别（S-mode）**\n- **机器级别（M-mode）**\n\n这些特权级别用于提供软件栈中不同组件之间的保护。尝试执行当前特权模式下不允许的操作会导致异常，这些异常通常会导致陷落到底层执行环境。 | 问题已解决。|
|mstatus寄存器中的MIE和SIE位有什么作用？|According to the reference information, mstatus寄存器中的MIE和SIE位的作用如下：\n\n- **MIE位**：MIE位位于mstatus寄存器的低8位，用于控制M-mode（机器模式）的全局中断使能。当MIE为1时，M-mode的中断全局使能；当MIE为0时，M-mode的中断全局禁止。对于更高特权模式的中断，它们始终处于全局使能状态，不受任何全局中断使能位的影响。\n- **SIE位**：SIE位同样位于mstatus寄存器的低8位，用于控制S-mode（监督模式）的全局中断使能。当SIE为1时，S-mode的中断全局使能；当SIE为0时，S-mode的中断全局禁止。对于更低特权模式的中断，它们始终处于全局禁止状态，不受任何全局中断使能位的影响。\n\n### 摘要\n- **MIE位和SIE位**的主要作用是确保在当前特权模式下的中断处理程序的原子性。\n- 这些位可以通过单一的CSR指令原子地设置或清除，从而确保中断处理的高效性和一致性。|存在中英文混杂问题，存在表述问题。| 根据参考信息，mstatus寄存器中的MIE和SIE位主要用于保证当前特权模式下中断处理程序的原子性。这些位位于mstatus寄存器的低阶位，可以通过单一的CSR指令原子地设置或清除。具体来说：\n\n- **MIE位**：用于M-mode（机器模式），当MIE=1时，中断全局启用；当MIE=0时，中断全局禁用。\n- **SIE位**：用于S-mode（监督模式），功能与MIE位类似。如果系统未实现监督模式，则SIE位为只读0。 | 问题已解决，表达相对于上次测试更为流畅。 |
|mcause寄存器如何表示异常和中断？|Error code: 503 - {'code': 50508, 'message': 'System is too busy now. Please try again later.', 'data': None}|测试失败，系统过于繁忙。由于本次测试通过远程API调用外部模型进行，未占用系统计算资源，考虑排查代码原因。| 根据参考信息，mcause寄存器用于表示异常和中断的方式如下：\n\n- **中断表示**：\n  - 当陷阱（trap）由中断引起时，mcause寄存器的最高位（Interrupt位）被设置为1。\n  - 中断的类型通过mcause寄存器中的Exception Code字段来编码。例如，Supervisor软件中断对应值1，Machine软件中断对应值3，Supervisor定时器中断对应值5，Machine定时器中断对应值7等。\n\n- **异常表示**：\n  - 当陷阱（trap）由异常引起时，mcause寄存器的最高位（Interrupt位）被设置为0。\n  - 异常的具体类型通过Exception Code字段来编码，如Instruction地址不对齐对应值0，Illegal指令对应值2，Load地址不对齐对应值4，Store/AMO地址不对齐对应值6等。\n\n- **特殊处理**：\n  - 对于非屏蔽中断（NMIs），mcause寄存器的值由实现定义，但Interrupt位应设置为1来表示这是一个中断。\n  - 未知原因的异常，Exception Code应设置为0。\n  - 若指令可能引发多个同步异常，mcause寄存器记录的是优先级最高的异常。\n\n以上信息基于提供的参考文档内容。 | 问题已解决。|

## 存在的问题总结

- PDF 未成功解析：需要排查系统中存在的 bug 并修正。
- 长 TXT 上传异常：可能是网络通信中延时设置问题。需要排查系统代码设置。
- 系统繁忙：问题同上。
- 输出中英文混杂：可能是RAG系统基座模型参数量过小原因。考虑采用参数量更大的模型。
- 查询输出事实错误：问题同上，检索和重排序给出的文本块正确，考虑为模型理解能力问题。
- 输出忽略部分事实：问题同上。

## 问题解决情况

更换基座模型和系统 prompt 后，

- PDF 仍未成功解析：下一步工作应当考虑重点排查代码流程中与之相关的问题。
- 长 TXT 上传异常：定位确认为网络栈异步函数同步问题，不影响使用，可以考虑修改异步逻辑。
- 输出中英文混杂：经过更换系统 prompt 已解决。
- 查询输出事实错误：经过更换基座模型已解决。
- 输出忽略部分事实：同上，已解决。